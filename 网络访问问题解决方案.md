# MoonTV ç½‘ç»œè®¿é—®é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸ” é—®é¢˜æè¿°

**ç—‡çŠ¶**:

- `wget http://localhost:3000` æˆ– `curl http://localhost:3000` å¯ä»¥æ­£å¸¸è®¿é—®
- ä½†ä½¿ç”¨ `wget http://æœåŠ¡å™¨IP:3000` æˆ– `curl http://æœåŠ¡å™¨IP:3000` æ— æ³•è®¿é—®

## ğŸ¯ é—®é¢˜åŸå› 

### 1. æœåŠ¡ç›‘å¬åœ°å€é…ç½®é”™è¯¯

**æœ€å¸¸è§çš„åŸå› **: Next.js åº”ç”¨é»˜è®¤åªç›‘å¬ localhost (127.0.0.1)ï¼Œè€Œä¸æ˜¯æ‰€æœ‰ç½‘ç»œæ¥å£ (0.0.0.0)

```bash
# æ£€æŸ¥å½“å‰ç›‘å¬çŠ¶æ€
netstat -tlnp | grep 3000

# é”™è¯¯çš„ç›‘å¬æ–¹å¼ (åªèƒ½localhostè®¿é—®)
tcp    127.0.0.1:3000           0.0.0.0:*               LISTEN

# æ­£ç¡®çš„ç›‘å¬æ–¹å¼ (æ‰€æœ‰IPå¯è®¿é—®)
tcp    0.0.0.0:3000              0.0.0.0:*               LISTEN
```

### 2. é˜²ç«å¢™é˜»æ­¢

**Ubuntu é˜²ç«å¢™è®¾ç½®**:

- UFW (Uncomplicated Firewall) é»˜è®¤å¯èƒ½é˜»æ­¢å¤–éƒ¨è®¿é—®
- iptables è§„åˆ™å¯èƒ½é™åˆ¶ç«¯å£è®¿é—®

### 3. äº‘æœåŠ¡å™¨å®‰å…¨ç»„

**äº‘æœåŠ¡å•†å®‰å…¨ç»„**:

- AWSã€é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰éœ€è¦å•ç‹¬é…ç½®å®‰å…¨ç»„è§„åˆ™
- é»˜è®¤å¯èƒ½åªå¼€æ”¾ SSH (22) ç«¯å£

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨å¿«é€Ÿä¿®å¤è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# ä¸‹è½½å¹¶è¿è¡Œä¿®å¤è„šæœ¬
sudo chmod +x network-fix.sh
sudo ./network-fix.sh
```

### æ–¹æ¡ˆäºŒï¼šæ‰‹åŠ¨ä¿®å¤

#### 1. Docker éƒ¨ç½²ä¿®å¤

```bash
# ç¼–è¾‘docker-compose.yml
cd /opt/moontv
nano docker-compose.yml

# ä¿®æ”¹ç«¯å£æ˜ å°„ï¼Œç¡®ä¿ç›‘å¬æ‰€æœ‰IP
ports:
  - '0.0.0.0:3000:3000'  # è€Œä¸æ˜¯ '3000:3000'

# æ·»åŠ ç¯å¢ƒå˜é‡
environment:
  - HOSTNAME=0.0.0.0
  - PASSWORD=your_password

# é‡å¯å®¹å™¨
docker-compose restart
```

#### 2. æºç éƒ¨ç½²ä¿®å¤

```bash
# ç¼–è¾‘ç¯å¢ƒå˜é‡æ–‡ä»¶
nano /opt/moontv/.env.production

# æ·»åŠ æˆ–ä¿®æ”¹ä»¥ä¸‹é…ç½®
HOSTNAME=0.0.0.0
PORT=3000

# ç¼–è¾‘systemdæœåŠ¡æ–‡ä»¶
sudo nano /etc/systemd/system/moontv.service

# åœ¨[Service]éƒ¨åˆ†æ·»åŠ ç¯å¢ƒå˜é‡
[Service]
Environment=HOSTNAME=0.0.0.0
Environment=PORT=3000

# é‡å¯æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl restart moontv
```

#### 3. é˜²ç«å¢™é…ç½®

```bash
# UFWé˜²ç«å¢™
sudo ufw allow 3000
sudo ufw reload

# æˆ–è€…ä½¿ç”¨iptables
sudo iptables -A INPUT -p tcp --dport 3000 -j ACCEPT

# ä¿å­˜iptablesè§„åˆ™
sudo iptables-save > /etc/iptables/rules.v4
```

#### 4. äº‘æœåŠ¡å™¨å®‰å…¨ç»„é…ç½®

**AWS EC2**:

1. ç™»å½• AWS æ§åˆ¶å°
2. è¿›å…¥ EC2 å®ä¾‹
3. é€‰æ‹©"å®‰å…¨ç»„"
4. æ·»åŠ å…¥ç«™è§„åˆ™: ç«¯å£ 3000, åè®® TCP, æ¥æº 0.0.0.0/0

**é˜¿é‡Œäº‘ ECS**:

1. ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°
2. è¿›å…¥ ECS å®ä¾‹
3. é€‰æ‹©"å®‰å…¨ç»„"
4. æ·»åŠ è§„åˆ™: ç«¯å£ 3000, åè®® TCP, æˆæƒå¯¹è±¡ 0.0.0.0/0

**è…¾è®¯äº‘ CVM**:

1. ç™»å½•è…¾è®¯äº‘æ§åˆ¶å°
2. è¿›å…¥ CVM å®ä¾‹
3. é€‰æ‹©"å®‰å…¨ç»„"
4. æ·»åŠ è§„åˆ™: ç«¯å£ 3000, åè®® TCP, æ¥æº 0.0.0.0/0

## ğŸ”§ è¯Šæ–­æ­¥éª¤

### 1. ä½¿ç”¨è¯Šæ–­è„šæœ¬

```bash
# è¿è¡Œå®Œæ•´è¯Šæ–­
sudo chmod +x network-diagnose.sh
sudo ./network-diagnose.sh
```

### 2. æ‰‹åŠ¨è¯Šæ–­

```bash
# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status moontv

# 2. æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep 3000

# 3. æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
sudo ufw status

# 4. æµ‹è¯•æœ¬åœ°è¿æ¥
curl -I http://localhost:3000

# 5. æµ‹è¯•å¤–éƒ¨IPè¿æ¥
curl -I http://$(hostname -I | awk '{print $1}'):3000

# 6. æ£€æŸ¥æ—¥å¿—
sudo journalctl -u moontv -f
```

## ğŸ“‹ å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: ä¿®å¤åä»ç„¶æ— æ³•è®¿é—®ï¼Ÿ

**æ£€æŸ¥æ¸…å•**:

1. âœ… ç«¯å£æ˜¯å¦ç›‘å¬åœ¨ 0.0.0.0:3000
2. âœ… é˜²ç«å¢™æ˜¯å¦å¼€æ”¾ 3000 ç«¯å£
3. âœ… äº‘æœåŠ¡å•†å®‰å…¨ç»„æ˜¯å¦é…ç½®
4. âœ… æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
5. âœ… ç½‘ç»œæ˜¯å¦é€šç•…

### Q2: å¦‚ä½•ç¡®è®¤ç›‘å¬åœ°å€ï¼Ÿ

```bash
# æŸ¥çœ‹è¯¦ç»†ç›‘å¬ä¿¡æ¯
sudo netstat -tlnp | grep 3000

# æˆ–ä½¿ç”¨sså‘½ä»¤
sudo ss -tlnp | grep 3000

# æœŸæœ›è¾“å‡º
tcp    0.0.0.0:3000    0.0.0.0:*    LISTEN    1234/node
```

### Q3: å¦‚ä½•éªŒè¯ä¿®å¤æ•ˆæœï¼Ÿ

```bash
# æœ¬åœ°æµ‹è¯•
curl http://localhost:3000

# å¤–éƒ¨IPæµ‹è¯•
curl http://ä½ çš„æœåŠ¡å™¨IP:3000

# æµè§ˆå™¨æµ‹è¯•
# æ‰“å¼€æµè§ˆå™¨è®¿é—®: http://ä½ çš„æœåŠ¡å™¨IP:3000
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ç”Ÿäº§ç¯å¢ƒé…ç½®

```bash
# ä½¿ç”¨ç¯å¢ƒå˜é‡æ§åˆ¶ç›‘å¬åœ°å€
export HOSTNAME=0.0.0.0
export PORT=3000

# åœ¨docker-compose.ymlä¸­æ˜ç¡®é…ç½®
services:
  moontv:
    environment:
      - HOSTNAME=0.0.0.0
      - PORT=3000
    ports:
      - '0.0.0.0:3000:3000'
```

### 2. å®‰å…¨è€ƒè™‘

```bash
# é™åˆ¶è®¿é—®æ¥æºï¼ˆå¯é€‰ï¼‰
sudo ufw allow from 192.168.1.0/24 to any port 3000

# æˆ–ä½¿ç”¨ç‰¹å®šIP
sudo ufw allow from YOUR_IP to any port 3000
```

### 3. ç›‘æ§å’Œç»´æŠ¤

```bash
# å®šæœŸæ£€æŸ¥ç«¯å£çŠ¶æ€
echo "0 */6 * * * netstat -tlnp | grep 3000 >> /var/log/port-monitor.log" | sudo crontab -

# è®¾ç½®ç«¯å£ç›‘æ§è„šæœ¬
cat > /opt/moontv/port-monitor.sh << 'EOF'
#!/bin/bash
if ! netstat -tlnp | grep -q "0.0.0.0:3000"; then
    echo "$(date): ç«¯å£3000ç›‘å¬å¼‚å¸¸ï¼Œå°è¯•é‡å¯æœåŠ¡" >> /var/log/moontv-port.log
    sudo systemctl restart moontv
fi
EOF

chmod +x /opt/moontv/port-monitor.sh
echo "*/5 * * * * /opt/moontv/port-monitor.sh" | sudo crontab -
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœä»¥ä¸Šè§£å†³æ–¹æ¡ˆéƒ½æ— æ³•è§£å†³æ‚¨çš„é—®é¢˜ï¼Œè¯·ï¼š

1. æ”¶é›†ç³»ç»Ÿä¿¡æ¯ï¼š

   ```bash
   uname -a
   lsb_release -a
   netstat -tlnp | grep 3000
   sudo ufw status
   ```

2. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š

   ```bash
   sudo journalctl -u moontv -n 50
   ```

3. æäº¤ Issue åˆ°é¡¹ç›®ä»“åº“ï¼ŒåŒ…å«å®Œæ•´çš„é”™è¯¯ä¿¡æ¯å’Œç³»ç»Ÿé…ç½®

---

**æœ€åæ›´æ–°**: 2025 å¹´ 1 æœˆ
**ç‰ˆæœ¬**: v1.0.0
